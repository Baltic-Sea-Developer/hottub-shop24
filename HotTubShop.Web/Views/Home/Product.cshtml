@model ProductConfiguratorViewModel
@{
    ViewData["Title"] = Model.Product.LocalizedName(Model.Language);
    var isSignedIn = User?.Identity?.IsAuthenticated ?? false;
    var requiredGroups = Model.Product.Options
        .Where(o => o.IsRequiredGroup)
        .Select(o => o.GroupName)
        .Distinct(StringComparer.OrdinalIgnoreCase)
        .ToList();
    var gallery = new List<string>();
    if (!string.IsNullOrWhiteSpace(Model.Product.ImageUrl))
    {
        gallery.Add(Model.Product.ImageUrl);
    }
    foreach (var img in Model.Product.GalleryImageUrls.Where(i => !string.IsNullOrWhiteSpace(i)))
    {
        if (!gallery.Contains(img, StringComparer.OrdinalIgnoreCase))
        {
            gallery.Add(img);
        }
    }
}

<a class="btn btn-link px-0 mb-3" asp-controller="Home" asp-action="Index" asp-route-lang="@Model.Language">@(Model.Language == "en" ? "Back to catalog" : "Zurück zum Katalog")</a>

<div class="row g-4">
    <div class="col-lg-5">
        <img id="main-product-image" src="@gallery.FirstOrDefault()" alt="@Model.Product.LocalizedName(Model.Language)" class="detail-image" />
        @if (gallery.Count > 1)
        {
            <div class="d-flex flex-wrap gap-2 mt-2">
                @foreach (var imageUrl in gallery)
                {
                    <button type="button" class="btn btn-sm btn-outline-secondary js-gallery-thumb" data-image="@imageUrl">
                        <img src="@imageUrl" alt="@Model.Product.LocalizedName(Model.Language)" style="width:64px;height:64px;object-fit:cover;" />
                    </button>
                }
            </div>
        }
        <div class="product-card mt-3 p-3">
            <h1 class="h3 mt-1">@Model.Product.LocalizedName(Model.Language)</h1>
            <div>@Html.Raw(Model.Product.LocalizedDescription(Model.Language))</div>
            @if (isSignedIn)
            {
                <p class="mb-0"><strong>Basis: @Model.Product.BasePrice.ToString("N0") EUR</strong></p>
            }
            else
            {
                <p class="mb-0 text-muted">
                    @(Model.Language == "en" ? "Prices are visible for registered customers only." : "Preise sind nur für registrierte Kunden sichtbar.")
                </p>
            }
        </div>
    </div>

    <div class="col-lg-7">
        <form method="post" asp-action="AddToCart" class="product-card p-3 p-lg-4">
            @Html.AntiForgeryToken()
            <input type="hidden" asp-for="Language" />
            <input type="hidden" asp-for="Product.Id" />
            <h2 class="h5 mb-3">@(Model.Language == "en" ? "Select modules" : "Zusatzbausteine Wählen")</h2>

            @foreach (var group in Model.Product.Options.GroupBy(o => o.GroupName))
            {
                var isRequiredGroup = requiredGroups.Contains(group.Key, StringComparer.OrdinalIgnoreCase);
                <div class="mb-3">
                    <h3 class="h6 text-uppercase text-secondary">
                        @group.Key
                        @if (isRequiredGroup)
                        {
                            <span class="text-danger">*</span>
                        }
                    </h3>
                    @foreach (var option in group)
                    {
                        Model.SelectedByGroup.TryGetValue(group.Key, out var selectedId);
                        var isChecked = selectedId == option.Id;
                        <div class="form-check option-item p-2 rounded">
                            <input
                                class="form-check-input js-option-radio"
                                type="radio"
                                name="SelectedByGroup[@group.Key]"
                                value="@option.Id"
                                checked="@isChecked"
                                id="opt_@option.Id"
                                data-price="@option.PriceDelta.ToString(System.Globalization.CultureInfo.InvariantCulture)"
                                data-group="@group.Key"
                                data-required-group="@isRequiredGroup.ToString().ToLowerInvariant()" />
                            <label class="form-check-label w-100" for="opt_@option.Id">
                                @if (!string.IsNullOrWhiteSpace(option.ImageUrl))
                                {
                                    <img src="@option.ImageUrl" alt="@option.LocalizedName(Model.Language)" class="option-thumb me-2" />
                                }
                                <span>@option.LocalizedName(Model.Language)</span>
                                @if (isSignedIn)
                                {
                                    <span class="float-end">+@option.PriceDelta.ToString("N0") EUR</span>
                                }
                                @if (!string.IsNullOrWhiteSpace(option.LocalizedDescription(Model.Language)))
                                {
                                    <div class="small text-muted mt-1">@Html.Raw(option.LocalizedDescription(Model.Language))</div>
                                }
                            </label>
                        </div>
                    }
                </div>
            }

            @if (isSignedIn)
            {
                <div class="alert alert-light mb-3" id="live-total"
                     data-base-price="@Model.Product.BasePrice.ToString(System.Globalization.CultureInfo.InvariantCulture)"
                     data-language="@Model.Language">
                    <strong>@(Model.Language == "en" ? "Total" : "Gesamtpreis"): <span id="live-total-value">@Model.Product.BasePrice.ToString("N0") EUR</span></strong>
                </div>
            }
            @if (requiredGroups.Count > 0)
            {
                <div class="small text-muted mb-3" id="required-groups-hint">
                    @(Model.Language == "en"
                        ? "Please select an option in all required groups (*) to continue."
                        : "Bitte wähle in allen Pflichtgruppen (*) eine Option, um fortzufahren.")
                </div>
            }
            <button type="submit" class="btn btn-success" id="add-to-cart-btn">@(Model.Language == "en" ? "Add to cart" : "In den Warenkorb")</button>
        </form>
    </div>
</div>

@section Scripts {
    <script>
        (() => {
            const mainImage = document.getElementById("main-product-image");
            const thumbs = Array.from(document.querySelectorAll(".js-gallery-thumb"));
            thumbs.forEach((btn) => {
                btn.addEventListener("click", () => {
                    if (mainImage && btn.dataset.image) {
                        mainImage.src = btn.dataset.image;
                    }
                });
            });

            const totalContainer = document.getElementById("live-total");
            if (!totalContainer) return;

            const totalValue = document.getElementById("live-total-value");
            const addToCartButton = document.getElementById("add-to-cart-btn");
            const requiredHint = document.getElementById("required-groups-hint");
            const basePrice = Number.parseFloat(totalContainer.dataset.basePrice || "0");
            const language = totalContainer.dataset.language || "de";
            const radios = Array.from(document.querySelectorAll(".js-option-radio"));
            const requiredGroupNames = new Set(
                radios
                    .filter(r => (r.dataset.requiredGroup || "false") === "true")
                    .map(r => r.dataset.group || "")
                    .filter(Boolean)
            );

            const locale = language === "en" ? "en-US" : "de-DE";
            const formatter = new Intl.NumberFormat(locale, {
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            });

            const refresh = () => {
                let optionsTotal = 0;
                const selectedRequiredGroups = new Set();

                radios.forEach((radio) => {
                    if (!radio.checked) {
                        return;
                    }

                    const delta = Number.parseFloat(radio.dataset.price || "0");
                    if (!Number.isNaN(delta)) {
                        optionsTotal += delta;
                    }

                    if ((radio.dataset.requiredGroup || "false") === "true" && radio.dataset.group) {
                        selectedRequiredGroups.add(radio.dataset.group);
                    }
                });

                const total = basePrice + optionsTotal;
                totalValue.textContent = `${formatter.format(total)} EUR`;

                const allRequiredSelected = requiredGroupNames.size === 0 || selectedRequiredGroups.size === requiredGroupNames.size;
                if (addToCartButton) {
                    addToCartButton.disabled = !allRequiredSelected;
                }
                if (requiredHint) {
                    requiredHint.style.display = allRequiredSelected ? "none" : "block";
                }
            };

            radios.forEach(r => r.addEventListener("change", refresh));
            refresh();
        })();
    </script>
}
